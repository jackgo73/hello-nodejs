<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <title>二次风控专用Excel模板转换</title>
    <style>
        #drop {
            border: 2px dashed #bbb;
            -moz-border-radius: 5px;
            -webkit-border-radius: 5px;
            border-radius: 5px;
            padding: 25px;
            text-align: center;
            font: 20pt bold, "Vollkorn";
            color: #bbb
        }

        #out {
            border: 2px dashed #bbb;
        }
    </style>
    <script src="xlsx.full.min.js"></script>
</head>
<body>
<pre>
<h1><b>二次风控专用Excel模板转换</b></h1>
<div id="drop">Drop a spreadsheet file here to see sheet data</div>
<input type="file" name="xlfile" id="xlf"/> ... or click here to select a file
</pre>
<br/>
<pre id="out">
R E S U L T
I S
I N
H E R E
</pre>
<br/>
<script>
    const comparison_table = {
        'C': '证件号码',
        'G': '客户名称',
        'O': '教育程度',
        'Q': '发生地详细地址',
        'R': '户籍地址',
        'S': '居住详细地址',
        'V': '通讯地址',
        'Y': '手机号码',
        'AA': '单位名称',
        'AB': '单位详细地址',
        'AD': '单位固话',
        'AP': '亲属联系人姓名',
        'AS': '亲属联系人手机',
        'AT': '其他联系人姓名',
        'AW': '其他联系人手机',
        'AU': '其他联系人关系',
        'BD': '收款卡号',
        'BH': '申请日期',
        'BI': '申请金额',
        'BK': '贷款期限'
    };
    let src = []

    function countLines(worksheet) {

        const offset = 2;
        const prefix = 'C';
        let nlines = 1;

        while (true) {
            let cell = worksheet[prefix + nlines];
            if (!cell) {
                break;
            }
            nlines++;
        }
        return nlines - offset;
    }

    function handleData(data) {
        let workbook = XLSX.read(data, {type: 'binary'});
        let sheet_name = workbook.SheetNames[0];
        let worksheet_src = workbook.Sheets[sheet_name];

        let line_number_src = countLines(worksheet_src);
        const hoffset = 2;
        for (let i = 0; i < line_number_src; i++) {
            let line_data = {};
            line_data[comparison_table['C']] = worksheet_src['C' + (i + hoffset)] ? worksheet_src['C' + (i + hoffset)].v : undefined;
            line_data[comparison_table['G']] = worksheet_src['G' + (i + hoffset)] ? worksheet_src['G' + (i + hoffset)].v : undefined;
            line_data[comparison_table['O']] = worksheet_src['O' + (i + hoffset)] ? worksheet_src['O' + (i + hoffset)].v : undefined;
            line_data[comparison_table['Q']] = worksheet_src['Q' + (i + hoffset)] ? worksheet_src['Q' + (i + hoffset)].v : undefined;
            line_data[comparison_table['R']] = worksheet_src['R' + (i + hoffset)] ? worksheet_src['R' + (i + hoffset)].v : undefined;
            line_data[comparison_table['S']] = worksheet_src['S' + (i + hoffset)] ? worksheet_src['S' + (i + hoffset)].v : undefined;
            line_data[comparison_table['V']] = worksheet_src['V' + (i + hoffset)] ? worksheet_src['V' + (i + hoffset)].v : undefined;
            line_data[comparison_table['Y']] = worksheet_src['Y' + (i + hoffset)] ? worksheet_src['Y' + (i + hoffset)].v : undefined;

            line_data[comparison_table['AA']] = worksheet_src['AA' + (i + hoffset)] ? worksheet_src['AA' + (i + hoffset)].v : undefined;
            line_data[comparison_table['AB']] = worksheet_src['AB' + (i + hoffset)] ? worksheet_src['AB' + (i + hoffset)].v : undefined;
            line_data[comparison_table['AD']] = worksheet_src['AD' + (i + hoffset)] ? ((worksheet_src['AD' + (i + hoffset)].v.length == 13) ? worksheet_src['AD' + (i + hoffset)].v : '') : undefined;
            line_data[comparison_table['AP']] = worksheet_src['AP' + (i + hoffset)] ? worksheet_src['AP' + (i + hoffset)].v : undefined;
            line_data[comparison_table['AS']] = worksheet_src['AS' + (i + hoffset)] ? worksheet_src['AS' + (i + hoffset)].v : undefined;
            line_data[comparison_table['AT']] = worksheet_src['AT' + (i + hoffset)] ? worksheet_src['AT' + (i + hoffset)].v : undefined;
            line_data[comparison_table['AW']] = worksheet_src['AW' + (i + hoffset)] ? worksheet_src['AW' + (i + hoffset)].v : undefined;
            line_data[comparison_table['AU']] = worksheet_src['AU' + (i + hoffset)] ? worksheet_src['AU' + (i + hoffset)].v : undefined;
            line_data[comparison_table['BD']] = worksheet_src['BD' + (i + hoffset)] ? worksheet_src['BD' + (i + hoffset)].v : undefined;
            line_data[comparison_table['BH']] = worksheet_src['BH' + (i + hoffset)] ? worksheet_src['BH' + (i + hoffset)].v : undefined;
            line_data[comparison_table['BI']] = worksheet_src['BI' + (i + hoffset)] ? worksheet_src['BI' + (i + hoffset)].v : undefined;
            line_data[comparison_table['BK']] = worksheet_src['BK' + (i + hoffset)] ? worksheet_src['BK' + (i + hoffset)].v : undefined;

            src[i] = line_data;
//                  console.log(worksheet_src['BI' + (i + hoffset)]);
        }
//              console.log(src);
        let string_bairong = new String();
        let string_tongdun = new String();

        for (let i = 0; i < line_number_src; i++) {
            string_bairong += src[i]['客户名称'] + ',' +
                src[i]['手机号码'] + ',' +
                src[i]['证件号码'] + ',' +
                src[i]['收款卡号'] + ',' + ',' + ',' + ',' +
                '网络申请' + ',' +
                '信用贷款' + ',' +
                src[i]['申请金额'] + ',' +
                src[i]['贷款期限'] + ',' +
                src[i]['教育程度'] + ',' + ',' + ',' +
                src[i]['单位名称'] + ',' +
                src[i]['居住详细地址'] + ',' +
                src[i]['单位详细地址'] + ',' +
                src[i]['户籍地址'] + ',' +
                src[i]['发生地详细地址'] + ',' +
                src[i]['单位固话'] + ',' + ',' +
                src[i]['亲属联系人姓名'] + ',' +
                src[i]['亲属联系人手机'] + ',' +
                '亲戚' + ',' +
                src[i]['其他联系人姓名'] + ',' +
                src[i]['其他联系人手机'] + ',' +
                src[i]['其他联系人关系'];
            string_bairong += '\n';
        }

        for (let i = 0; i < line_number_src; i++) {
            string_tongdun += src[i]['申请日期'].replace(/\//g, '-') + ',' +
                src[i]['申请金额'] + ',' +
                src[i]['贷款期限'] + ',' + ',' + ',' + ',' + ',' + ',' +
                src[i]['客户名称'] + ',' +
                src[i]['证件号码'] + ',' +
                src[i]['手机号码'] + ',' + ',' + ',' + ',' +
                src[i]['收款卡号'] + ',' +
                src[i]['居住详细地址'] + ',' + ',' +
                src[i]['单位名称'] + ',' +
                src[i]['单位详细地址'] + ',' + ',' + ',' + ',' + ',' + ',' + ',' + ',' +
                src[i]['单位固话'] + ',' + ',' + ',' + ',' + ',' + ',' +
                src[i]['通讯地址'] + ',' + ',' +
                src[i]['亲属联系人姓名'] + ',' +
                src[i]['亲属联系人手机'] + ',' +
                src[i]['其他联系人姓名'] + ',' +
                src[i]['其他联系人手机'];

            string_tongdun += '\n';
        }


        var OUT = document.getElementById('out');
        OUT.innerText = 'BR Result\n' + string_bairong + '\nTD Result\n' + string_tongdun + '\n';
    };

    (function () {
        let xlf = document.getElementById('xlf');
        if (!xlf.addEventListener) return;

        xlf.addEventListener('change', function (e) {
            let files = e.target.files;
            let file = files[0];
            let reader = new FileReader();

            reader.onload = function (e) {
                let data = e.target.result;
                handleData(data);
            };

            reader.readAsBinaryString(file);

        });
    })();

    (function () {
        var drop = document.getElementById('drop');
        if (!drop.addEventListener) return;

        drop.addEventListener('dragenter', function (e) {
            e.stopPropagation();
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        }, false);

        drop.addEventListener('dragover', function (e) {
            e.stopPropagation();
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        }, false);

        drop.addEventListener('drop', function (e) {
            e.stopPropagation();
            e.preventDefault();

            let files = e.dataTransfer.files;
            let file = files[0];
            let reader = new FileReader();

            reader.onload = function (e) {
                let data = e.target.result;
                handleData(data);
            };
            reader.readAsBinaryString(file);
        }, false);
    })();

</script>


</body>
</html>